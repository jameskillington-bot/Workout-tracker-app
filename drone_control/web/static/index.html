<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Drone Control Dashboard</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --border: #2a2d3a;
    --text: #e0e0e0;
    --dim: #888;
    --accent: #4fc3f7;
    --danger: #ef5350;
    --success: #66bb6a;
    --warn: #ffa726;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg); color: var(--text);
    display: flex; flex-direction: column; height: 100vh;
  }
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 20px; background: var(--surface);
    border-bottom: 1px solid var(--border);
  }
  header h1 { font-size: 1.2rem; font-weight: 600; }
  header h1 span { color: var(--accent); }
  .status-dot {
    width: 10px; height: 10px; border-radius: 50%;
    display: inline-block; margin-right: 8px;
  }
  .status-dot.connected { background: var(--success); }
  .status-dot.disconnected { background: var(--danger); }
  .header-right { display: flex; align-items: center; gap: 12px; }

  main {
    display: grid; flex: 1; overflow: hidden;
    grid-template-columns: 280px 1fr 300px;
    grid-template-rows: 1fr 200px 180px;
    gap: 1px; background: var(--border);
  }
  .panel {
    background: var(--surface); padding: 16px;
    overflow-y: auto;
  }
  .panel h2 {
    font-size: 0.85rem; text-transform: uppercase;
    letter-spacing: 0.08em; color: var(--dim); margin-bottom: 12px;
  }

  /* Left panel: telemetry */
  .telemetry { grid-row: 1 / 4; }
  .telem-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
  }
  .telem-card {
    background: var(--bg); border-radius: 8px; padding: 10px;
    text-align: center;
  }
  .telem-card .label { font-size: 0.7rem; color: var(--dim); text-transform: uppercase; }
  .telem-card .value { font-size: 1.4rem; font-weight: 700; margin-top: 2px; }
  .telem-card .unit { font-size: 0.7rem; color: var(--dim); }
  .battery-bar {
    margin-top: 12px; background: var(--bg); border-radius: 8px;
    padding: 10px;
  }
  .battery-bar .bar {
    height: 8px; border-radius: 4px; background: #333;
    margin-top: 6px; overflow: hidden;
  }
  .battery-bar .bar .fill {
    height: 100%; border-radius: 4px;
    transition: width 0.5s, background 0.5s;
  }

  /* Center: map canvas */
  .map-panel { position: relative; display: flex; flex-direction: column; }
  .map-panel canvas {
    flex: 1; width: 100%;
    background: #0d0f14; border-radius: 4px;
  }
  .map-legend {
    position: absolute; bottom: 10px; left: 10px;
    background: rgba(15,17,23,0.85); padding: 6px 10px;
    border-radius: 6px; font-size: 0.7rem; color: var(--dim);
  }
  .map-hint {
    position: absolute; top: 10px; right: 10px;
    background: rgba(15,17,23,0.85); padding: 6px 10px;
    border-radius: 6px; font-size: 0.7rem; color: var(--accent);
    display: none;
  }

  /* Camera view panel */
  .camera-panel { position: relative; display: flex; flex-direction: column; }
  .camera-panel canvas {
    flex: 1; width: 100%;
    background: #0a0c10; border-radius: 4px;
  }
  .camera-label {
    position: absolute; top: 8px; left: 12px;
    font-size: 0.7rem; color: var(--danger); font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.1em;
  }
  .camera-status {
    position: absolute; top: 8px; right: 12px;
    font-size: 0.7rem; font-weight: 600;
    padding: 2px 8px; border-radius: 4px;
  }
  .camera-status.clear { color: var(--success); }
  .camera-status.avoiding { color: var(--warn); }
  .camera-status.critical { color: var(--danger); }

  /* Right panel: controls */
  .controls { grid-row: 1 / 4; display: flex; flex-direction: column; gap: 12px; }
  .btn-group { display: flex; gap: 6px; flex-wrap: wrap; }
  .btn {
    padding: 8px 14px; border: 1px solid var(--border);
    border-radius: 6px; background: var(--bg); color: var(--text);
    font-size: 0.82rem; cursor: pointer; transition: 0.15s;
    flex: 1; text-align: center; min-width: 80px;
  }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn.primary { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 600; }
  .btn.primary:hover { opacity: 0.85; }
  .btn.danger { background: var(--danger); color: #fff; border-color: var(--danger); }
  .btn.danger:hover { opacity: 0.85; }
  .btn.success { background: var(--success); color: #000; border-color: var(--success); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* D-pad */
  .dpad {
    display: grid; grid-template-columns: 60px 60px 60px;
    grid-template-rows: 44px 44px 44px;
    gap: 4px; justify-content: center; margin: 8px 0;
  }
  .dpad .btn { min-width: unset; padding: 4px; font-size: 1.1rem; }

  /* Altitude/yaw */
  .vert-controls {
    display: flex; gap: 8px; justify-content: center;
  }
  .vert-controls .btn { flex: unset; width: 70px; }

  /* Routine/autonomous selector */
  select, .coord-input {
    width: 100%; padding: 8px; border-radius: 6px;
    border: 1px solid var(--border); background: var(--bg);
    color: var(--text); font-size: 0.85rem;
  }
  .coord-row {
    display: flex; gap: 6px; margin-top: 6px;
  }
  .coord-row label {
    font-size: 0.7rem; color: var(--dim); display: block; margin-bottom: 2px;
  }
  .coord-row input {
    width: 100%; padding: 5px 8px; border-radius: 4px;
    border: 1px solid var(--border); background: var(--bg);
    color: var(--text); font-size: 0.85rem; text-align: center;
  }

  .nav-status {
    margin-top: 6px; padding: 8px; background: var(--bg);
    border-radius: 6px; font-size: 0.75rem; color: var(--dim);
    line-height: 1.5;
  }
  .nav-status .status-val { color: var(--accent); font-weight: 600; }
  .nav-status .warn-val { color: var(--warn); font-weight: 600; }

  /* Bottom: log */
  .log-panel { grid-column: 2; }
  .log-list {
    font-family: 'Cascadia Code', 'Fira Code', monospace;
    font-size: 0.75rem; line-height: 1.6;
    color: var(--dim); max-height: 140px; overflow-y: auto;
  }

  /* Responsive */
  @media (max-width: 900px) {
    main {
      grid-template-columns: 1fr;
      grid-template-rows: auto;
    }
    .telemetry, .controls, .log-panel, .camera-panel { grid-row: auto; grid-column: auto; }
    .map-panel canvas { height: 250px; }
  }
</style>
</head>
<body>

<header>
  <h1><span>&#9654;</span> Drone Control</h1>
  <div class="header-right">
    <span class="status-dot disconnected" id="statusDot"></span>
    <span id="statusText">Disconnected</span>
    <button class="btn primary" id="btnConnect" onclick="toggleConnect()">Connect</button>
  </div>
</header>

<main>
  <!-- LEFT: Telemetry -->
  <div class="panel telemetry">
    <h2>Telemetry</h2>
    <div class="telem-grid">
      <div class="telem-card">
        <div class="label">Altitude</div>
        <div class="value" id="tAlt">0</div>
        <div class="unit">cm</div>
      </div>
      <div class="telem-card">
        <div class="label">Speed</div>
        <div class="value" id="tSpeed">0</div>
        <div class="unit">cm/s</div>
      </div>
      <div class="telem-card">
        <div class="label">Pos X</div>
        <div class="value" id="tX">0</div>
        <div class="unit">cm</div>
      </div>
      <div class="telem-card">
        <div class="label">Pos Y</div>
        <div class="value" id="tY">0</div>
        <div class="unit">cm</div>
      </div>
      <div class="telem-card">
        <div class="label">Yaw</div>
        <div class="value" id="tYaw">0</div>
        <div class="unit">deg</div>
      </div>
      <div class="telem-card">
        <div class="label">Flight Time</div>
        <div class="value" id="tTime">0</div>
        <div class="unit">sec</div>
      </div>
      <div class="telem-card">
        <div class="label">Temp</div>
        <div class="value" id="tTemp">--</div>
        <div class="unit">&deg;C</div>
      </div>
      <div class="telem-card">
        <div class="label">Status</div>
        <div class="value" id="tFlight" style="font-size:1rem">GROUNDED</div>
        <div class="unit">&nbsp;</div>
      </div>
    </div>
    <div class="battery-bar">
      <div class="label" style="font-size:0.75rem;color:var(--dim)">
        Battery: <span id="tBat">100</span>%
      </div>
      <div class="bar"><div class="fill" id="batFill" style="width:100%;background:var(--success)"></div></div>
    </div>

    <h2 style="margin-top:18px">Autopilot</h2>
    <select id="routineSelect">
      <option value="square">Square Pattern</option>
      <option value="circle">Circle Pattern</option>
      <option value="figure_eight">Figure-8 Pattern</option>
      <option value="survey_grid">Survey Grid</option>
    </select>
    <div class="btn-group" style="margin-top:8px">
      <button class="btn success" onclick="loadRoutine()">Load</button>
      <button class="btn primary" onclick="startAutopilot()">Start</button>
      <button class="btn" onclick="pauseAutopilot()">Pause</button>
      <button class="btn danger" onclick="abortAutopilot()">Abort</button>
    </div>
    <div id="autopilotStatus" style="margin-top:8px;font-size:0.78rem;color:var(--dim)">No plan loaded</div>

    <h2 style="margin-top:18px">Autonomous Nav</h2>
    <div style="font-size:0.72rem;color:var(--dim);margin-bottom:6px">
      Click the map to set destination, or enter coords:
    </div>
    <div class="coord-row">
      <div style="flex:1"><label>X (cm)</label><input type="number" id="navX" value="200"></div>
      <div style="flex:1"><label>Y (cm)</label><input type="number" id="navY" value="200"></div>
      <div style="flex:1"><label>Z (cm)</label><input type="number" id="navZ" value="80"></div>
    </div>
    <div class="btn-group" style="margin-top:8px">
      <button class="btn primary" onclick="setDestination()">Set Dest</button>
      <button class="btn success" onclick="startNav()">Navigate</button>
      <button class="btn danger" onclick="stopNav()">Stop</button>
    </div>
    <div class="nav-status" id="navStatus">
      Status: <span class="status-val">idle</span>
    </div>
  </div>

  <!-- CENTER: Map -->
  <div class="panel map-panel">
    <h2>Position Map</h2>
    <canvas id="mapCanvas"></canvas>
    <div class="map-legend">Grid: 50cm &bull; Blue = drone &bull; Click = set destination</div>
    <div class="map-hint" id="mapHint">Click to set nav destination</div>
  </div>

  <!-- RIGHT: Controls -->
  <div class="panel controls">
    <h2>Flight Controls</h2>
    <div class="btn-group">
      <button class="btn success" onclick="cmd('takeoff')">Takeoff</button>
      <button class="btn danger" onclick="cmd('land')">Land</button>
    </div>
    <button class="btn danger" style="width:100%" onclick="cmd('emergency')">EMERGENCY STOP</button>

    <h2>Movement</h2>
    <div class="dpad">
      <div></div>
      <button class="btn" onclick="move('forward',50)">&uarr;</button>
      <div></div>
      <button class="btn" onclick="move('left',50)">&larr;</button>
      <button class="btn" style="font-size:0.7rem" onclick="move('forward',0)">&bull;</button>
      <button class="btn" onclick="move('right',50)">&rarr;</button>
      <div></div>
      <button class="btn" onclick="move('back',50)">&darr;</button>
      <div></div>
    </div>

    <h2>Altitude &amp; Yaw</h2>
    <div class="vert-controls">
      <button class="btn" onclick="move('up',30)">&uarr; Up</button>
      <button class="btn" onclick="move('down',30)">&darr; Down</button>
      <button class="btn" onclick="rotate(-45)">&circlearrowleft;</button>
      <button class="btn" onclick="rotate(45)">&circlearrowright;</button>
    </div>

    <h2>Speed</h2>
    <div style="display:flex;align-items:center;gap:8px">
      <input type="range" id="speedSlider" min="10" max="100" value="50"
        style="flex:1" oninput="setSpeed(this.value)">
      <span id="speedVal" style="min-width:40px;text-align:right">50</span>
    </div>

    <h2 style="margin-top:auto">Keyboard</h2>
    <div style="font-size:0.72rem;color:var(--dim);line-height:1.6">
      WASD: move &bull; QE: rotate<br>
      R: up &bull; F: down<br>
      T: takeoff &bull; L: land &bull; Space: emergency<br>
      N: start/stop autonomous nav
    </div>
  </div>

  <!-- CENTER ROW 2: Camera View -->
  <div class="panel camera-panel">
    <h2>Camera View</h2>
    <canvas id="cameraCanvas"></canvas>
    <span class="camera-label" id="camLabel">CAM</span>
    <span class="camera-status clear" id="camStatus">CLEAR</span>
  </div>

  <!-- BOTTOM CENTER: Log -->
  <div class="panel log-panel">
    <h2>Flight Log</h2>
    <div class="log-list" id="logList"></div>
  </div>
</main>

<script>
// ---- State ----
let connected = false;
let pollTimer = null;
let obstacles = [];
let navDestination = null;
let navActive = false;

// Obstacle colors
const OBS_COLORS = {
  building: { fill: 'rgba(160,82,45,0.6)', stroke: '#A0522D', cam: [160,82,45] },
  tree:     { fill: 'rgba(46,139,87,0.5)',  stroke: '#2E8B57', cam: [46,139,87] },
  wall:     { fill: 'rgba(128,128,128,0.5)',stroke: '#808080', cam: [128,128,128] },
  pillar:   { fill: 'rgba(176,196,222,0.5)',stroke: '#B0C4DE', cam: [176,196,222] },
};

// ---- API helpers ----
async function api(path, method='POST', body=null) {
  const opts = { method };
  if (body) {
    opts.headers = { 'Content-Type': 'application/json' };
    opts.body = JSON.stringify(body);
  }
  const res = await fetch('/api/' + path, opts);
  return res.json();
}

// ---- Connection ----
async function toggleConnect() {
  if (!connected) {
    const r = await api('connect');
    if (r.success) {
      connected = true;
      document.getElementById('statusDot').className = 'status-dot connected';
      document.getElementById('statusText').textContent = 'Connected';
      document.getElementById('btnConnect').textContent = 'Disconnect';
      loadEnvironment();
      startPolling();
    }
  } else {
    await api('disconnect');
    connected = false;
    document.getElementById('statusDot').className = 'status-dot disconnected';
    document.getElementById('statusText').textContent = 'Disconnected';
    document.getElementById('btnConnect').textContent = 'Connect';
    stopPolling();
  }
}

// ---- Commands ----
async function cmd(name) { await api(name); }
async function move(dir, dist) { await api('move', 'POST', { direction: dir, distance: dist }); }
async function rotate(deg) { await api('rotate', 'POST', { degrees: deg }); }
async function setSpeed(v) {
  document.getElementById('speedVal').textContent = v;
  await api('speed', 'POST', { speed: parseInt(v) });
}

// ---- Autopilot ----
async function loadRoutine() {
  const name = document.getElementById('routineSelect').value;
  const r = await api('autopilot/load', 'POST', { routine: name });
  if (r.success) updateAutopilotUI(r.plan);
}
async function startAutopilot() { await api('autopilot/start'); }
async function pauseAutopilot() { await api('autopilot/pause'); }
async function abortAutopilot() { await api('autopilot/abort'); }

function updateAutopilotUI(plan) {
  const el = document.getElementById('autopilotStatus');
  if (!plan || plan.status === 'idle') {
    el.innerHTML = plan ? `<b>${plan.name}</b> loaded — ${plan.waypoints.length} waypoints` : 'No plan loaded';
  } else {
    const wp = plan.waypoints || [];
    const reached = wp.filter(w => w.status === 'reached').length;
    el.innerHTML = `<b>${plan.name}</b> — ${plan.status} (${reached}/${wp.length} waypoints)`;
  }
}

// ---- Autonomous Navigation ----
async function loadEnvironment() {
  const data = await api('environment', 'GET');
  obstacles = data.obstacles || [];
}

async function setDestination() {
  const x = parseFloat(document.getElementById('navX').value) || 0;
  const y = parseFloat(document.getElementById('navY').value) || 0;
  const z = parseFloat(document.getElementById('navZ').value) || 80;
  const r = await api('autonomous/destination', 'POST', { x, y, z });
  if (r.success) {
    navDestination = r.destination;
  }
}

async function startNav() {
  if (!navDestination) await setDestination();
  const r = await api('autonomous/start');
  if (r.success) navActive = true;
}

async function stopNav() {
  await api('autonomous/stop');
  navActive = false;
}

function updateNavUI(status) {
  navActive = status.active;
  if (status.destination) navDestination = status.destination;

  const el = document.getElementById('navStatus');
  const s = status.status;
  const d = status.distance_to_goal;
  const a = status.avoidance_action;

  let avoidClass = 'status-val';
  if (a === 'avoiding') avoidClass = 'warn-val';
  if (a === 'critical') avoidClass = 'warn-val';

  let html = `Status: <span class="status-val">${s}</span>`;
  if (status.destination) {
    html += `<br>Dest: (${status.destination.x}, ${status.destination.y}, ${status.destination.z})`;
    html += `<br>Distance: <span class="status-val">${d} cm</span>`;
  }
  if (status.active) {
    html += `<br>Avoidance: <span class="${avoidClass}">${a}</span>`;
  }
  if (status.reached) {
    html += `<br><span class="status-val">DESTINATION REACHED</span>`;
  }
  el.innerHTML = html;

  // Update camera status badge
  const camStatus = document.getElementById('camStatus');
  if (a === 'critical') {
    camStatus.textContent = 'OBSTACLE';
    camStatus.className = 'camera-status critical';
  } else if (a === 'avoiding') {
    camStatus.textContent = 'AVOIDING';
    camStatus.className = 'camera-status avoiding';
  } else {
    camStatus.textContent = 'CLEAR';
    camStatus.className = 'camera-status clear';
  }
}

// ---- Map click to set destination ----
document.addEventListener('DOMContentLoaded', () => {
  const canvas = document.getElementById('mapCanvas');
  canvas.addEventListener('click', (e) => {
    if (!connected) return;
    const rect = canvas.getBoundingClientRect();
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    const scale = 1.5;
    const clickX = (e.clientX - rect.left) * (canvas.width / rect.width);
    const clickY = (e.clientY - rect.top) * (canvas.height / rect.height);
    const worldX = (clickX - cx) / scale;
    const worldY = -(clickY - cy) / scale;

    document.getElementById('navX').value = Math.round(worldX);
    document.getElementById('navY').value = Math.round(worldY);
    setDestination();
  });
});

// ---- Telemetry polling ----
function startPolling() {
  if (pollTimer) return;
  pollTimer = setInterval(poll, 200);
}
function stopPolling() {
  if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
}

async function poll() {
  try {
    const [state, ap, navSt, camFrame] = await Promise.all([
      api('state', 'GET'),
      api('autopilot/status', 'GET'),
      api('autonomous/status', 'GET'),
      api('camera', 'GET'),
    ]);
    updateTelemetry(state);
    updateAutopilotUI(ap);
    updateNavUI(navSt);
    drawMap(state, ap);
    drawCamera(camFrame);
  } catch(e) {}
}

function updateTelemetry(s) {
  document.getElementById('tAlt').textContent = s.z;
  document.getElementById('tSpeed').textContent = s.speed;
  document.getElementById('tX').textContent = s.x;
  document.getElementById('tY').textContent = s.y;
  document.getElementById('tYaw').textContent = s.yaw;
  document.getElementById('tTime').textContent = s.flight_time;
  document.getElementById('tTemp').textContent = s.temperature;
  document.getElementById('tBat').textContent = Math.round(s.battery);
  document.getElementById('tFlight').textContent = s.is_flying ? 'FLYING' : 'GROUNDED';
  document.getElementById('tFlight').style.color = s.is_flying ? 'var(--accent)' : 'var(--dim)';

  const pct = Math.round(s.battery);
  const fill = document.getElementById('batFill');
  fill.style.width = pct + '%';
  fill.style.background = pct > 50 ? 'var(--success)' : pct > 20 ? 'var(--warn)' : 'var(--danger)';

  // Log
  if (s.log) {
    const el = document.getElementById('logList');
    el.innerHTML = s.log.map(l => `<div>${l}</div>`).join('');
    el.scrollTop = el.scrollHeight;
  }
}

// ---- Map drawing ----
function drawMap(state, ap) {
  const canvas = document.getElementById('mapCanvas');
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width - 32;
  canvas.height = rect.height - 60;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const cx = W / 2, cy = H / 2;
  const scale = 1.5; // pixels per cm

  ctx.clearRect(0, 0, W, H);

  // Grid
  ctx.strokeStyle = '#1e2030';
  ctx.lineWidth = 1;
  const gridStep = 50 * scale;
  for (let x = cx % gridStep; x < W; x += gridStep) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
  }
  for (let y = cy % gridStep; y < H; y += gridStep) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  // Origin cross
  ctx.strokeStyle = '#333';
  ctx.beginPath(); ctx.moveTo(cx-8,cy); ctx.lineTo(cx+8,cy); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx,cy-8); ctx.lineTo(cx,cy+8); ctx.stroke();

  // Obstacles
  for (const obs of obstacles) {
    const px = cx + obs.x * scale;
    const py = cy - obs.y * scale;
    const colors = OBS_COLORS[obs.type] || OBS_COLORS.building;

    ctx.fillStyle = colors.fill;
    ctx.strokeStyle = colors.stroke;
    ctx.lineWidth = 1.5;

    if (obs.is_cylindrical) {
      const r = (obs.width / 2) * scale;
      ctx.beginPath();
      ctx.arc(px, py, r, 0, Math.PI * 2);
      ctx.fill();
      ctx.stroke();
    } else {
      const w = obs.width * scale;
      const d = obs.depth * scale;
      ctx.fillRect(px - w/2, py - d/2, w, d);
      ctx.strokeRect(px - w/2, py - d/2, w, d);
    }

    // Label
    ctx.fillStyle = colors.stroke;
    ctx.font = '9px sans-serif';
    ctx.fillText(obs.type, px - 12, py + 3);
  }

  // Destination marker
  if (navDestination) {
    const dx = cx + navDestination.x * scale;
    const dy = cy - navDestination.y * scale;

    // Dashed line from drone to destination
    ctx.strokeStyle = '#ef5350';
    ctx.lineWidth = 1;
    ctx.setLineDash([6, 4]);
    ctx.beginPath();
    ctx.moveTo(cx + state.x * scale, cy - state.y * scale);
    ctx.lineTo(dx, dy);
    ctx.stroke();
    ctx.setLineDash([]);

    // Target crosshair
    ctx.strokeStyle = '#ef5350';
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(dx, dy, 8, 0, Math.PI * 2); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(dx - 12, dy); ctx.lineTo(dx + 12, dy); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(dx, dy - 12); ctx.lineTo(dx, dy + 12); ctx.stroke();

    ctx.fillStyle = '#ef5350';
    ctx.font = '10px monospace';
    ctx.fillText(`(${navDestination.x}, ${navDestination.y})`, dx + 14, dy - 6);
  }

  // Waypoints
  if (ap && ap.waypoints) {
    ctx.strokeStyle = '#ff9800';
    ctx.lineWidth = 1.5;
    ctx.setLineDash([4,4]);
    ctx.beginPath();
    ap.waypoints.forEach((wp, i) => {
      const px = cx + wp.x * scale;
      const py = cy - wp.y * scale;
      if (i === 0) ctx.moveTo(px, py);
      else ctx.lineTo(px, py);
    });
    ctx.stroke();
    ctx.setLineDash([]);

    ap.waypoints.forEach((wp, i) => {
      const px = cx + wp.x * scale;
      const py = cy - wp.y * scale;
      ctx.fillStyle = wp.status === 'reached' ? '#66bb6a'
                     : wp.status === 'active' ? '#ffa726' : '#555';
      ctx.beginPath();
      ctx.arc(px, py, 5, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = '#888';
      ctx.font = '10px sans-serif';
      ctx.fillText(i+1, px+7, py+3);
    });
  }

  // Drone
  const dx = cx + state.x * scale;
  const dy = cy - state.y * scale;
  const yawRad = -state.yaw * Math.PI / 180;

  // Camera FOV cone
  if (state.is_flying) {
    const fovHalf = 35 * Math.PI / 180; // 70 deg total
    const coneLen = 120 * scale;
    ctx.fillStyle = 'rgba(79,195,247,0.06)';
    ctx.beginPath();
    ctx.moveTo(dx, dy);
    ctx.lineTo(dx + Math.cos(yawRad - fovHalf) * coneLen,
               dy - Math.sin(yawRad - fovHalf) * coneLen);
    ctx.lineTo(dx + Math.cos(yawRad + fovHalf) * coneLen,
               dy - Math.sin(yawRad + fovHalf) * coneLen);
    ctx.closePath();
    ctx.fill();
  }

  // Trail dot
  ctx.fillStyle = 'rgba(79,195,247,0.15)';
  ctx.beginPath(); ctx.arc(dx, dy, 3, 0, Math.PI*2); ctx.fill();

  // Drone triangle
  ctx.save();
  ctx.translate(dx, dy);
  ctx.rotate(yawRad);
  ctx.fillStyle = '#4fc3f7';
  ctx.beginPath();
  ctx.moveTo(0, -10);
  ctx.lineTo(-7, 7);
  ctx.lineTo(7, 7);
  ctx.closePath();
  ctx.fill();
  ctx.restore();

  // Coords label
  ctx.fillStyle = '#4fc3f7';
  ctx.font = '11px monospace';
  ctx.fillText(`(${state.x}, ${state.y}) z=${state.z}`, dx + 12, dy - 4);
}

// ---- Camera view drawing (Wolfenstein-style raycaster) ----
function drawCamera(frame) {
  if (!frame) return;
  const canvas = document.getElementById('cameraCanvas');
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width - 32;
  canvas.height = rect.height - 50;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;

  // Sky gradient
  const skyGrad = ctx.createLinearGradient(0, 0, 0, H / 2);
  skyGrad.addColorStop(0, '#0a0e1a');
  skyGrad.addColorStop(1, '#1a2040');
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0, 0, W, H / 2);

  // Ground gradient
  const gndGrad = ctx.createLinearGradient(0, H / 2, 0, H);
  gndGrad.addColorStop(0, '#1a1a14');
  gndGrad.addColorStop(1, '#0d0d0a');
  ctx.fillStyle = gndGrad;
  ctx.fillRect(0, H / 2, W, H / 2);

  const numRays = frame.num_rays;
  const colWidth = W / numRays;
  const maxRange = frame.max_range;
  const projConst = H * 1.2; // projection constant

  for (let i = 0; i < numRays; i++) {
    const depth = frame.depths[i];
    const obsType = frame.obstacle_types[i];
    const obsHeight = frame.obstacle_heights[i];

    if (!obsType || depth >= maxRange) continue;

    // Wall strip height based on distance (perspective projection)
    const wallScreenH = Math.min(H, (projConst * Math.min(obsHeight, 200)) / (depth * 2));
    const wallTop = (H - wallScreenH) / 2;

    // Color based on obstacle type, darkened by distance
    const baseColor = OBS_COLORS[obsType] ? OBS_COLORS[obsType].cam : [128, 128, 128];
    const fog = Math.max(0.15, 1 - (depth / maxRange) * 0.85);
    const r = Math.round(baseColor[0] * fog);
    const g = Math.round(baseColor[1] * fog);
    const b = Math.round(baseColor[2] * fog);

    // Slight variation for left/right sides of obstacles
    const shade = (i % 2 === 0) ? 0 : -15;

    ctx.fillStyle = `rgb(${Math.max(0,r+shade)},${Math.max(0,g+shade)},${Math.max(0,b+shade)})`;
    ctx.fillRect(i * colWidth, wallTop, colWidth + 1, wallScreenH);

    // Top edge highlight
    ctx.fillStyle = `rgba(255,255,255,${fog * 0.15})`;
    ctx.fillRect(i * colWidth, wallTop, colWidth + 1, 2);
  }

  // Danger indicator bars for close obstacles
  const sectorWidth = W / numRays;
  for (let i = 0; i < numRays; i++) {
    const depth = frame.depths[i];
    if (depth < 100) {
      const urgency = 1 - depth / 100;
      ctx.fillStyle = `rgba(239,83,80,${urgency * 0.4})`;
      ctx.fillRect(i * sectorWidth, H - 4, sectorWidth + 1, 4);
    }
  }

  // Center reticle
  ctx.strokeStyle = 'rgba(79,195,247,0.5)';
  ctx.lineWidth = 1;
  const rcx = W / 2, rcy = H / 2;
  ctx.beginPath(); ctx.moveTo(rcx - 10, rcy); ctx.lineTo(rcx - 4, rcy); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(rcx + 4, rcy); ctx.lineTo(rcx + 10, rcy); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(rcx, rcy - 10); ctx.lineTo(rcx, rcy - 4); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(rcx, rcy + 4); ctx.lineTo(rcx, rcy + 10); ctx.stroke();

  // Depth range bar at bottom
  ctx.fillStyle = 'rgba(15,17,23,0.7)';
  ctx.fillRect(0, H - 20, W, 20);
  const minDepth = Math.min(...frame.depths);
  const depthColor = minDepth < 50 ? '#ef5350' : minDepth < 100 ? '#ffa726' : '#66bb6a';
  ctx.fillStyle = depthColor;
  ctx.font = '10px monospace';
  ctx.fillText(`Nearest: ${Math.round(minDepth)} cm`, 8, H - 7);

  // Heading
  ctx.fillStyle = '#4fc3f7';
  ctx.fillText(`HDG ${Math.round(frame.drone_yaw)}°`, W - 70, H - 7);
}

// ---- Keyboard controls ----
document.addEventListener('keydown', (e) => {
  if (!connected) return;
  if (e.target.tagName === 'INPUT') return; // skip when typing in inputs
  switch(e.key.toLowerCase()) {
    case 'w': move('forward', 30); break;
    case 's': move('back', 30); break;
    case 'a': move('left', 30); break;
    case 'd': move('right', 30); break;
    case 'q': rotate(-30); break;
    case 'e': rotate(30); break;
    case 'r': move('up', 20); break;
    case 'f': move('down', 20); break;
    case 't': cmd('takeoff'); break;
    case 'l': cmd('land'); break;
    case ' ': e.preventDefault(); cmd('emergency'); break;
    case 'n':
      if (navActive) stopNav();
      else startNav();
      break;
  }
});

// Initial canvas size
window.addEventListener('resize', () => {
  if (connected) poll();
});
</script>
</body>
</html>
